<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DealCraft AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        .main-container {
            position: relative;
            z-index: 1;
        }
        .modal-sheet {
            transform: translateY(-150%);
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal-sheet.is-open {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
        .chat-bubble-lead { background-color: #374151; color: #F9FAFB; }
        .chat-bubble-user { background-color: #3B82F6; color: #fff; }
        .spinner {
            border: 2px solid rgba(255,255,255,0.2);
            border-left-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-200">
    <canvas id="bg-canvas"></canvas>
    <div class="main-container w-full h-screen p-4 sm:p-6 md:p-8 flex items-center justify-center">
        <!-- App Window -->
        <div class="w-full h-full max-w-6xl bg-gray-900/70 backdrop-blur-xl shadow-2xl rounded-2xl flex flex-col overflow-hidden border border-gray-700/80">
            <!-- Header -->
            <header class="h-16 flex-shrink-0 flex items-center justify-between px-6 bg-gray-900/80 border-b border-gray-700/60">
                <h1 class="text-xl font-bold text-white tracking-wider">DealCraft AI</h1>
                <button id="marketing-advisor-btn" class="flex items-center justify-center px-4 py-2 rounded-lg bg-green-600/80 hover:bg-green-500 transition-colors text-white text-sm font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 19 9 19 7c0-2.2-1.8-4-4-4S9 4.8 9 7c0 2 1.3 3.2 2.5 4.5.8.8 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                    <span class="ml-2">Marketing Advisor</span>
                </button>
            </header>

            <!-- Main Content -->
            <div class="flex flex-grow h-full overflow-hidden">
                <!-- Sidebar -->
                <aside class="w-1/3 md:w-1/4 h-full bg-gray-800/50 border-r border-gray-700/60 flex flex-col">
                    <nav id="leads-list" class="flex-grow overflow-y-auto p-3 space-y-2"></nav>
                    <div class="p-3 border-t border-gray-700/60">
                        <button id="new-lead-btn" class="w-full flex items-center justify-center p-3 rounded-lg bg-blue-600 hover:bg-blue-500 transition-colors text-white font-semibold">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            <span class="ml-2">New Lead</span>
                        </button>
                    </div>
                </aside>

                <!-- Interaction Pane -->
                <main id="interaction-pane" class="w-2/3 md:w-3/4 h-full flex flex-col bg-gray-900/20">
                    <div id="placeholder-view" class="flex-grow flex flex-col items-center justify-center text-gray-400 p-8 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="m15 18-6-6 6-6"/><path d="M9 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h5"/><path d="M21 12h-6"/></svg>
                        <p class="mt-4 text-lg font-medium">Select a lead to continue</p>
                        <p class="text-sm text-gray-500">or create a new lead to get started.</p>
                    </div>
                    
                    <div id="conversation-view" class="hidden flex-grow flex flex-col h-full">
                        <div class="p-4 border-b border-gray-700/60 flex-shrink-0 flex justify-between items-center">
                            <h2 id="lead-name-header" class="text-xl font-bold text-white"></h2>
                            <button id="export-chat-btn" title="Export Chat" class="p-2 rounded-lg hover:bg-gray-700 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                        <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto"></div>
                        <div class="p-4 border-t border-gray-700/60 bg-gray-900/30">
                            <div id="generated-reply-container" class="hidden mb-4">
                                <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">MentorMax Reply</label>
                                <div class="mt-2 p-3 bg-gray-800 rounded-lg text-gray-200 relative min-h-[80px]">
                                    <p id="generated-reply-text" class="whitespace-pre-wrap"></p>
                                    <div class="absolute top-2 right-2 flex space-x-1">
                                        <button id="add-to-chat-btn" title="Add to Chat" class="p-2 rounded-md hover:bg-gray-700 text-gray-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                        </button>
                                        <button id="copy-text-btn" title="Copy Text" class="p-2 rounded-md hover:bg-gray-700 text-gray-300">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                             <textarea id="lead-response-input" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-200" rows="3" placeholder="Paste the lead's latest response here..."></textarea>
                             <button id="generate-reply-btn" class="w-full mt-2 p-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                <span id="generate-reply-btn-text">Generate Reply</span>
                             </button>
                        </div>
                    </div>

                    <div id="marketing-view" class="hidden flex-grow flex-col h-full p-6">
                        <h2 class="text-2xl font-bold text-white mb-4">Marketing Advisor</h2>
                        <p class="text-gray-400 mb-6">To get the best advice, tell me about your product and target audience.</p>
                        <div id="marketing-advice-display" class="flex-grow p-4 bg-gray-800 rounded-lg text-gray-300 overflow-y-auto mb-4 hidden whitespace-pre-wrap"></div>
                        <textarea id="marketing-prompt-input" class="w-full p-3 bg-gray-800 border border-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="e.g., I sell handmade leather wallets to men aged 25-40..."></textarea>
                        <button id="get-advice-btn" class="w-full mt-2 p-3 bg-green-600 text-white font-semibold rounded-md hover:bg-green-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                            <span id="get-advice-btn-text">Get Advice</span>
                        </button>
                    </div>
                </main>
            </div>
        </div>

        <!-- New Lead Modal -->
        <div id="new-lead-modal" class="modal-sheet fixed inset-0 bg-black/60 flex items-center justify-center p-4">
            <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-2xl w-full max-w-md p-6">
                <h3 class="text-lg font-bold text-white">Create New Lead</h3>
                <div class="mt-4">
                    <label class="text-sm font-medium text-gray-400">Lead's Name</label>
                    <input id="new-lead-name" type="text" class="w-full mt-1 p-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mt-4">
                    <label class="text-sm font-medium text-gray-400">Select Persona</label>
                    <div id="persona-selector" class="grid grid-cols-2 gap-3 mt-2">
                        <button data-persona="sales" class="flex flex-col items-center p-4 border-2 border-gray-600 rounded-lg hover:border-blue-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <span class="mt-2 text-sm font-semibold">Sales Professional</span>
                        </button>
                        <button data-persona="negotiator" class="flex flex-col items-center p-4 border-2 border-gray-600 rounded-lg hover:border-purple-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-400"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9.09 9.91 5.82 5.82M14.91 9.91l-5.82 5.82"/></svg>
                            <span class="mt-2 text-sm font-semibold">Negotiator</span>
                        </button>
                    </div>
                </div>
                 <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancel-lead-btn" class="px-4 py-2 bg-gray-700 text-gray-200 rounded-md hover:bg-gray-600 transition-colors">Cancel</button>
                    <button id="create-lead-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-500 transition-colors disabled:opacity-50" disabled>Create Lead</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 3D Background Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);

        const geometry = new THREE.IcosahedronGeometry(1.5, 0);
        const wireframe = new THREE.WireframeGeometry(geometry);
        const line = new THREE.LineSegments(wireframe);
        line.material.depthTest = false;
        line.material.opacity = 0.4;
        line.material.transparent = true;
        line.material.color = new THREE.Color(0x3B82F6);
        scene.add(line);

        camera.position.z = 5;

        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            line.rotation.x += delta * 0.1;
            line.rotation.y += delta * 0.15;
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- DOM ELEMENTS ---
        const leadsListEl = document.getElementById('leads-list');
        const newLeadBtn = document.getElementById('new-lead-btn');
        const marketingAdvisorBtn = document.getElementById('marketing-advisor-btn');
        const leadResponseInput = document.getElementById('lead-response-input');
        const generateReplyBtn = document.getElementById('generate-reply-btn');
        const generateReplyBtnText = document.getElementById('generate-reply-btn-text');
        const generatedReplyContainer = document.getElementById('generated-reply-container');
        const generatedReplyText = document.getElementById('generated-reply-text');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const addToChatBtn = document.getElementById('add-to-chat-btn');
        const exportChatBtn = document.getElementById('export-chat-btn');
        const getAdviceBtn = document.getElementById('get-advice-btn');
        const getAdviceBtnText = document.getElementById('get-advice-btn-text');
        const marketingAdviceDisplay = document.getElementById('marketing-advice-display');
        const marketingPromptInput = document.getElementById('marketing-prompt-input');
        const newLeadModal = document.getElementById('new-lead-modal');
        const newLeadNameInput = document.getElementById('new-lead-name');
        const personaSelector = document.getElementById('persona-selector');
        const cancelLeadBtn = document.getElementById('cancel-lead-btn');
        const createLeadBtn = document.getElementById('create-lead-btn');
        const conversationView = document.getElementById('conversation-view');
        const marketingView = document.getElementById('marketing-view');
        const placeholderView = document.getElementById('placeholder-view');
        const leadNameHeader = document.getElementById('lead-name-header');
        const chatHistoryEl = document.getElementById('chat-history');

        // --- APP STATE ---
        let state = {
            leads: [],
            activeLeadId: null,
            activePersona: null,
            appMode: 'leads', // 'leads' or 'marketing'
            generatedReply: null,
            isLoading: false,
        };

        // --- API & AI CONFIG ---
        const apiKey = "AIzaSyAHe02OF0nzX3saxNSU4Ijy3Nr9WkysAi0"; // Left empty as per instructions
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const mentorMaxSystemPrompt = `You are "MentorMax," an AI sales and negotiation strategist. Your personality is that of a seasoned, sharp, and ENCOURAGING mentor with 30+ years of C-suite level experience. Your goal is to empower the user to achieve their objectives by crafting friendly, appealing, and highly effective replies. Your advice is built on proven methodologies (SPIN Selling, Challenger Sale, principled negotiation), but your tone is always collaborative and positive.

Your ultimate goal is to generate responses that understand the lead's needs so deeply and frame the value so compellingly that it maximizes the chance of conversion. You must tailor your response to one of two modes:

Mode 1: [SALES PROFESSIONAL]
Goal: Convert the lead into a customer.
Tactics:
- Build genuine rapport: Be courteous, friendly, and use the lead's name.
- Handle objections gracefully: Acknowledge their concern ("That's a very fair question..."), reframe it, and pivot back to the value proposition.
- Value-First: Focus on the benefits and outcomes that solve THEIR specific problem.
- Ask insightful, open-ended questions to uncover needs and pain points.
- Always include a gentle, clear call to action (e.g., "Would you be open to a brief 15-minute call next week to explore this further?").

Mode 2: [NEGOTIATOR]
Goal: Secure the most favorable terms in a deal.
Tactics:
- Professional & Positive Tone: Maintain a calm, objective, and firm but friendly tone. Avoid emotional language.
- Identify Interests: Look past their stated demand to understand their underlying need.
- BATNA Awareness: Your responses should strengthen the user's position.
- Reciprocity: Frame requests as fair exchanges. "To make that work on our end, we would need [your request] to maintain a balanced partnership. How does that sound?"
- Strategic Questions: Use simple, clarifying questions to put the onus back on them.

Execution: You will be given context, conversation history, and the lead's latest response. Generate a concise, powerful, and ready-to-send reply. DO NOT include explanations in the reply itself. The reply is what the user sends directly to their lead.`;

        // --- DATA HANDLING ---
        const saveState = () => localStorage.setItem('dealcraft-ai-data-v3', JSON.stringify(state.leads));
        const loadState = () => {
            const data = localStorage.getItem('dealcraft-ai-data-v3');
            state.leads = data ? JSON.parse(data) : [];
        };
        
        // --- UI & LOADING MANAGEMENT ---
        const setLoading = (loading) => {
            state.isLoading = loading;
            generateReplyBtn.disabled = loading;
            getAdviceBtn.disabled = loading;
            
            if (loading) {
                generateReplyBtnText.innerHTML = `<div class="spinner"></div><span class="ml-2">Generating...</span>`;
                getAdviceBtnText.innerHTML = `<div class="spinner"></div><span class="ml-2">Getting Advice...</span>`;
            } else {
                generateReplyBtnText.innerHTML = 'Generate Reply';
                getAdviceBtnText.innerHTML = 'Get Advice';
            }
        };

        // --- RENDER FUNCTIONS ---
        const render = () => {
            saveState();
            renderLeadsList();
            renderInteractionPane();
        };

        const renderLeadsList = () => {
            leadsListEl.innerHTML = '';
            state.leads.forEach(lead => {
                const isActive = lead.id === state.activeLeadId && state.appMode === 'leads';
                const personaTag = lead.persona === 'sales' 
                    ? `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-500/30 text-blue-300">SALES</span>`
                    : `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-purple-500/30 text-purple-300">NEGOTIATOR</span>`;
                
                leadsListEl.innerHTML += `
                    <button data-lead-id="${lead.id}" class="w-full text-left p-3 rounded-lg transition-colors ${isActive ? 'bg-blue-600/50' : 'hover:bg-gray-700/50'}">
                        <h3 class="font-semibold text-sm truncate text-white">${lead.name}</h3>
                        <div class="mt-1.5">${personaTag}</div>
                    </button>
                `;
            });
        };

        const renderInteractionPane = () => {
            const isMarketing = state.appMode === 'marketing';
            marketingView.classList.toggle('hidden', !isMarketing);
            
            const hasActiveLead = state.activeLeadId && !isMarketing;
            conversationView.classList.toggle('hidden', !hasActiveLead);
            placeholderView.classList.toggle('hidden', hasActiveLead || isMarketing);
            
            if (hasActiveLead) {
                renderConversation();
                if (state.generatedReply) {
                    generatedReplyText.textContent = state.generatedReply;
                    generatedReplyContainer.classList.remove('hidden');
                } else {
                    generatedReplyContainer.classList.add('hidden');
                }
            }
        };

        const renderConversation = () => {
            const lead = state.leads.find(l => l.id === state.activeLeadId);
            if (!lead) return;
            leadNameHeader.textContent = lead.name;
            chatHistoryEl.innerHTML = '';
            lead.history.forEach(msg => {
                const bubbleClass = msg.sender === 'lead' ? 'chat-bubble-lead self-start' : 'chat-bubble-user self-end';
                chatHistoryEl.innerHTML += `<div class="max-w-xl p-3 rounded-lg ${bubbleClass}">${msg.content.replace(/\n/g, '<br>')}</div>`;
            });
            setTimeout(() => {
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
            }, 0);
            if (!state.generatedReply) leadResponseInput.value = '';
        };

        // --- EVENT HANDLERS ---
        newLeadBtn.addEventListener('click', () => newLeadModal.classList.add('is-open'));
        cancelLeadBtn.addEventListener('click', () => newLeadModal.classList.remove('is-open'));
        newLeadModal.addEventListener('click', (e) => {
            if (e.target.id === 'new-lead-modal') newLeadModal.classList.remove('is-open');
        });

        personaSelector.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            state.activePersona = button.dataset.persona;
            personaSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('border-blue-500', 'border-purple-500', 'bg-gray-700'));
            const colorClass = state.activePersona === 'sales' ? 'border-blue-500' : 'border-purple-500';
            button.classList.add(colorClass, 'bg-gray-700');
            validateNewLeadForm();
        });

        newLeadNameInput.addEventListener('input', validateNewLeadForm);

        function validateNewLeadForm() {
            createLeadBtn.disabled = !(newLeadNameInput.value.trim() && state.activePersona);
        }

        const createLead = () => {
            const newLead = { id: Date.now().toString(), name: newLeadNameInput.value.trim(), persona: state.activePersona, history: [] };
            state.leads.unshift(newLead);
            state.activeLeadId = newLead.id;
            state.appMode = 'leads';
            state.generatedReply = null;
            newLeadModal.classList.remove('is-open');
            newLeadNameInput.value = '';
            state.activePersona = null;
            personaSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('border-blue-500', 'border-purple-500', 'bg-gray-700'));
            validateNewLeadForm();
            render();
        };

        const selectLead = (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.leadId) {
                state.activeLeadId = button.dataset.leadId;
                state.appMode = 'leads';
                state.generatedReply = null;
                render();
            }
        };

        const copyReply = () => {
            navigator.clipboard.writeText(generatedReplyText.textContent);
            copyTextBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
            setTimeout(() => {
                 copyTextBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
            }, 2000);
        };

        const addReplyToChat = () => {
            const lead = state.leads.find(l => l.id === state.activeLeadId);
            if (!lead || !state.generatedReply) return;
            lead.history.push({ sender: 'user', content: state.generatedReply });
            state.generatedReply = null;
            render();
        };
        
        const exportChat = () => {
            const lead = state.leads.find(l => l.id === state.activeLeadId);
            if (!lead) return;

            let chatText = `Conversation with: ${lead.name}\nPersona: ${lead.persona.toUpperCase()}\n\n`;
            lead.history.forEach(msg => {
                const prefix = msg.sender === 'lead' ? lead.name : 'You';
                chatText += `[${prefix}]:\n${msg.content}\n\n--------------------------------\n\n`;
            });

            const blob = new Blob([chatText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${lead.name.replace(/\s/g, '_')}_chat_history.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const showMarketingAdvisor = () => {
            state.appMode = 'marketing';
            state.activeLeadId = null;
            state.generatedReply = null;
            render();
        };

        // --- AI API CALLS ---
        const generateAIReply = async () => {
            const lead = state.leads.find(l => l.id === state.activeLeadId);
            const responseText = leadResponseInput.value.trim();
            if (!lead || !responseText || state.isLoading) return;

            setLoading(true);
            state.generatedReply = "Generating response, please wait...";
            render();

            const chatHistoryString = lead.history.map(msg => `${msg.sender === 'lead' ? lead.name : 'You'}: ${msg.content}`).join('\n');
            const userQuery = `CONTEXT:\n- Lead Name: ${lead.name}\n- My Active Mode: [${lead.persona.toUpperCase()}]\n- Conversation History:\n${chatHistoryString}\n\nLEAD'S LATEST RESPONSE:\n"${responseText}"\n\nINSTRUCTION:\nBased on all the context above, generate the perfect, ready-to-send reply for me to send back to ${lead.name}.`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: mentorMaxSystemPrompt }] },
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                
                const result = await response.json();
                const reply = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (reply) {
                    lead.history.push({ sender: 'lead', content: responseText });
                    state.generatedReply = reply;
                } else {
                    throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                console.error("AI Generation Error:", error);
                state.generatedReply = `Sorry, an error occurred. Please try again.\n\nDetails: ${error.message}`;
            } finally {
                setLoading(false);
                render();
            }
        };
        
        const getAIMarketingAdvice = async () => {
            const prompt = marketingPromptInput.value.trim();
            if (!prompt || state.isLoading) return;
            
            setLoading(true);
            marketingAdviceDisplay.innerHTML = "Getting advice from MentorMax...";
            marketingAdviceDisplay.classList.remove('hidden');

            const systemInstruction = `You are "MentorMax" in Marketing Strategist mode. A user will provide context about their product/service and target audience. Provide actionable, modern marketing tips covering areas like digital marketing, content strategy, social media engagement, and lead generation. Be encouraging and clear.`;
            const userQuery = `Here is my context: "${prompt}". Please provide marketing advice.`;

            try {
                 const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] },
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                
                const result = await response.json();
                const advice = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (advice) {
                    marketingAdviceDisplay.innerHTML = advice;
                } else {
                     throw new Error("Invalid response structure from API.");
                }
            } catch (error) {
                 console.error("Marketing Advice Error:", error);
                 marketingAdviceDisplay.textContent = `Sorry, an error occurred. Please try again.\n\nDetails: ${error.message}`;
            } finally {
                setLoading(false);
            }
        };

        // Bind Events
        createLeadBtn.addEventListener('click', createLead);
        leadsListEl.addEventListener('click', selectLead);
        generateReplyBtn.addEventListener('click', generateAIReply);
        copyTextBtn.addEventListener('click', copyReply);
        addToChatBtn.addEventListener('click', addReplyToChat);
        exportChatBtn.addEventListener('click', exportChat);
        marketingAdvisorBtn.addEventListener('click', showMarketingAdvisor);
        getAdviceBtn.addEventListener('click', getAIMarketingAdvice);

        // --- INITIALIZATION ---
        const init = () => {
            loadState();
            render();
        };

        init();
    });
    </script>
</body>
</html>
